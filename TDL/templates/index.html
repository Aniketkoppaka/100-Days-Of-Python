<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo List | Modern & Minimal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #6366f1;
            background-image: linear-gradient(to right top, #818cf8, #6366f1, #4f46e5); /* Indigo gradient */
            overflow: hidden;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .task-input:focus, .task-input-edit:focus {
            box-shadow: 0 0 0 3px #a5b4fc;
            outline: none;
        }
        .task-item {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .task-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .task-item .actions {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .task-item:hover .actions {
            opacity: 1;
        }
        .custom-checkbox:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .completed-task {
            opacity: 0.6;
        }
        .completed-task .task-text {
            text-decoration: line-through;
            color: #475569;
        }

        .motivational-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }
        .motivational-bg span {
            position: absolute;
            color: rgba(255, 255, 255, 0.15);
            font-size: 2vw;
            font-weight: 800;
            white-space: nowrap;
            animation: drift 80s linear infinite alternate;
            text-transform: uppercase;
        }

        @keyframes drift {
            from { transform: translateX(-15vw) rotate(var(--r-from)); }
            to { transform: translateX(15vw) rotate(var(--r-to)); }
        }

        .main-content {
            position: relative;
            z-index: 1;
            height: 100vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Motivational Background Text -->
    <div class="motivational-bg">
        <span style="top: 10%; left: 5%; --r-from: -15deg; --r-to: 5deg;">The secret of getting ahead...</span>
        <span style="top: 20%; left: 70%; --r-from: 10deg; --r-to: -5deg; animation-delay: -15s;">Keep going.</span>
        <span style="top: 35%; left: 15%; --r-from: 5deg; --r-to: 15deg; animation-delay: -25s;">One day or day one.</span>
        <span style="top: 50%; left: 60%; --r-from: -10deg; --r-to: 0deg; animation-delay: -35s;">Well done is better than well said.</span>
        <span style="top: 65%; left: 5%; --r-from: 12deg; --r-to: -12deg; animation-delay: -45s;">Success is the sum of small efforts.</span>
        <span style="top: 80%; left: 75%; --r-from: -5deg; --r-to: 10deg; animation-delay: -55s;">Do something today...</span>
        <span style="top: 90%; left: 20%; --r-from: 8deg; --r-to: -2deg; animation-delay: -5s;">Believe you can.</span>
    </div>

    <!-- Main Content Wrapper -->
    <div class="main-content">
        <div class="flex flex-col items-center pt-12 sm:pt-20 px-4 pb-20">
            <div class="w-full max-w-2xl mx-auto">

                <!-- Header -->
                <header class="text-center mb-10">
                    <h1 class="text-4xl sm:text-5xl font-extrabold text-white tracking-tight">
                        My Tasks
                    </h1>
                    <p class="mt-3 text-lg text-indigo-200">Stay organized, get things done.</p>
                </header>

                <!-- Add Task Form -->
                <div class="glass-card rounded-xl shadow-lg p-4 mb-8">
                    <form id="add-todo-form" class="flex flex-col sm:flex-row items-center gap-3">
                        <input type="text" id="task" name="task" placeholder="Add a new task..." required
                               class="task-input flex-grow w-full px-4 py-3 bg-white/50 border-transparent rounded-lg focus:ring-0 transition">
                        <input type="text" id="category" name="category" placeholder="Category"
                               class="task-input w-full sm:w-32 px-4 py-3 bg-white/50 border-transparent rounded-lg focus:ring-0 transition">
                        <input type="date" id="deadline" name="deadline"
                               class="task-input w-full sm:w-auto px-4 py-3 bg-white/50 border-transparent rounded-lg focus:ring-0 transition text-slate-500">
                        <button type="submit" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold px-5 py-3 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 shadow-md hover:shadow-lg">
                            Add
                        </button>
                    </form>
                </div>

                <!-- Todo List -->
                <div id="todo-list" class="space-y-4">
                    {% for todo in todos %}
                    <div class="task-item glass-card rounded-xl shadow-md p-5 flex items-center justify-between {% if todo.completed %}completed-task{% endif %}" data-id="{{ todo.id }}">
                        <div class="flex items-center gap-4 flex-grow">
                            <input type="checkbox" {% if todo.completed %}checked{% endif %} class="custom-checkbox h-6 w-6 rounded-md border-slate-400 focus:ring-indigo-500 cursor-pointer">
                            <div class="flex-grow">
                                <p class="task-text font-semibold text-slate-800 text-lg">{{ todo.task }}</p>
                                <div class="flex items-center gap-4 text-sm text-slate-600 mt-1">
                                    {% if todo.category %}
                                    <span class="category-badge bg-indigo-100 text-indigo-800 font-medium">{{ todo.category }}</span>
                                    {% endif %}
                                    {% if todo.deadline %}
                                    <span class="flex items-center gap-1.5">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                                        {{ todo.deadline.strftime('%b %d, %Y') }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="actions flex items-center gap-2">
                            <button class="edit-btn p-2 text-slate-500 hover:text-indigo-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button class="delete-btn p-2 text-slate-500 hover:text-red-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="text-center py-16 {% if todos %}hidden{% endif %}">
                    <div class="glass-card inline-block p-8 rounded-2xl">
                        <svg class="mx-auto h-16 w-16 text-indigo-800" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h3 class="mt-4 text-lg font-semibold text-slate-800">All tasks completed!</h3>
                        <p class="mt-1 text-base text-slate-600">You're all caught up. Add a new task to get started.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // All JavaScript remains the same
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('add-todo-form');
            const todoList = document.getElementById('todo-list');
            const emptyState = document.getElementById('empty-state');

            async function fetchTodos() {
                try {
                    const response = await fetch('/todos');
                    if (!response.ok) throw new Error('Network response was not ok');
                    const todos = await response.json();
                    renderTodos(todos);
                } catch (error) {
                    console.error('Failed to fetch todos:', error);
                    todoList.innerHTML = '<p class="text-red-500 text-center">Failed to load tasks. Please try again later.</p>';
                }
            }

            function renderTodos(todos) {
                todoList.innerHTML = '';
                if (todos.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    todos.forEach(todo => {
                        const todoItem = createTodoElement(todo);
                        todoList.appendChild(todoItem);
                    });
                }
            }

            function createTodoElement(todo) {
                const div = document.createElement('div');
                div.className = `task-item glass-card rounded-xl shadow-md p-5 flex items-center justify-between ${todo.completed ? 'completed-task' : ''}`;
                div.dataset.id = todo.id;

                const isOverdue = todo.deadline && !todo.completed && new Date(todo.deadline) < new Date().setHours(0,0,0,0);

                div.innerHTML = `
                    <div class="flex items-center gap-4 flex-grow">
                        <input type="checkbox" ${todo.completed ? 'checked' : ''} class="custom-checkbox h-6 w-6 rounded-md border-slate-400 focus:ring-indigo-500 cursor-pointer">
                        <div class="flex-grow">
                            <p class="task-text font-semibold text-slate-800 text-lg">${escapeHTML(todo.task)}</p>
                            <div class="flex items-center gap-4 text-sm text-slate-600 mt-1">
                                ${todo.category ? `<span class="category-badge bg-indigo-100 text-indigo-800 font-medium">${escapeHTML(todo.category)}</span>` : ''}
                                ${todo.deadline ? `
                                    <span class="flex items-center gap-1.5 ${isOverdue ? 'text-red-500 font-semibold' : ''}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                                        ${new Date(todo.deadline + 'T00:00:00').toLocaleDateString()}
                                    </span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="actions flex items-center gap-2">
                         <button class="edit-btn p-2 text-slate-500 hover:text-indigo-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button class="delete-btn p-2 text-slate-500 hover:text-red-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `;
                return div;
            }

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const task = document.getElementById('task').value;
                const category = document.getElementById('category').value;
                const deadline = document.getElementById('deadline').value;

                try {
                    const response = await fetch('/todos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ task, category, deadline }),
                    });
                    if (!response.ok) throw new Error('Failed to add todo');

                    form.reset();
                    fetchTodos();
                } catch (error) {
                    console.error(error);
                    alert('Error adding task. Please try again.');
                }
            });

            todoList.addEventListener('click', async function(e) {
                const target = e.target;
                const todoItem = target.closest('.task-item');
                if (!todoItem) return;

                const id = todoItem.dataset.id;

                if (target.type === 'checkbox') {
                    const completed = target.checked;
                    try {
                        const response = await fetch(`/todos/${id}/complete`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ completed }),
                        });
                        if (!response.ok) throw new Error('Failed to update status');

                        todoItem.classList.toggle('completed-task', completed);

                    } catch (error) {
                        console.error(error);
                        alert('Error updating task status.');
                        target.checked = !completed;
                    }
                }

                if (target.closest('.delete-btn')) {
                    if (confirm('Are you sure you want to delete this task?')) {
                         try {
                            const response = await fetch(`/todos/${id}`, { method: 'DELETE' });
                            if (!response.ok) throw new Error('Failed to delete');
                            todoItem.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                            todoItem.style.opacity = '0';
                            todoItem.style.transform = 'translateX(20px)';
                            setTimeout(() => {
                                todoItem.remove();
                                if (todoList.children.length === 0) {
                                    emptyState.classList.remove('hidden');
                                }
                            }, 300);
                        } catch (error) {
                            console.error(error);
                            alert('Error deleting task.');
                        }
                    }
                }

                if (target.closest('.edit-btn')) {
                    toggleEditView(todoItem);
                }
            });

            function toggleEditView(todoItem) {
                const taskTextElement = todoItem.querySelector('.task-text');
                const id = todoItem.dataset.id;

                if (todoItem.querySelector('.task-input-edit')) return;

                const currentTask = taskTextElement.textContent;

                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentTask;
                input.className = 'task-input-edit w-full text-lg px-2 py-1 bg-white/80 border border-slate-300 rounded-md';

                taskTextElement.replaceWith(input);
                input.focus();
                input.select();

                const saveEdit = async () => {
                    const newTask = input.value.trim();
                    if (newTask && newTask !== currentTask) {
                        try {
                            const response = await fetch(`/todos/${id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ task: newTask }),
                            });
                             if (!response.ok) throw new Error('Failed to update task');
                            taskTextElement.textContent = newTask;
                            input.replaceWith(taskTextElement);
                        } catch (error) {
                            console.error('Error updating task:', error);
                            alert('Failed to save changes.');
                            input.replaceWith(taskTextElement);
                        }
                    } else {
                        input.replaceWith(taskTextElement);
                    }
                };

                input.addEventListener('blur', saveEdit);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') input.blur();
                    else if (e.key === 'Escape') {
                        input.value = currentTask;
                        input.blur();
                    }
                });
            }

            function escapeHTML(str) {
                return str.replace(/[&<>"']/g, function(match) {
                    return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
                });
            }
        });
    </script>

</body>
</html>
